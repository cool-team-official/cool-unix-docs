import{a0 as t,G as e,aI as a,a4 as i,aM as s,d as n,r as l,a1 as h,o as c,c as r,w as o,am as u,aP as d,t as x,_ as m,e as g,n as v,aJ as f,a7 as w,a as p,v as y,f as M,g as b,u as S}from"./index-C9No-3tr.js";import{g as k}from"./device.BeibAdzp.js";import{c as I}from"./file.CRUAyLFd.js";import{u as T,o as R,r as _,d as A,b as X}from"./cl-page.uvue_vue_type_script_setup_true_lang.BYryoqR_.js";import{_ as Y}from"./cl-footer.CPL-dXAo.js";class P{constructor(e){this.context=null,this.ctx=null,this.scope=null,this.canvasId=null,this.renderQuene=[],this.imageQueue=[];const a=t().proxy;this.scope=a,this.canvasId=e}create(){return e(this,void 0,void 0,(function*(){const t=k();return new Promise((e=>{a({id:this.canvasId,component:this.scope,success:a=>{this.context=a,this.ctx=a.getContext("2d"),this.ctx.scale(t,t),e()}})}))}))}height(t){return this.ctx.canvas.height=t,this}width(t){return this.ctx.canvas.width=t,this}div(t){return this.renderQuene.push((()=>e(this,void 0,void 0,(function*(){this.divRender(t)})))),this}text(t){return this.renderQuene.push((()=>e(this,void 0,void 0,(function*(){this.textRender(t)})))),this}image(t){return this.imageQueue.push(t),this.renderQuene.push((()=>e(this,void 0,void 0,(function*(){yield this.imageRender(t)})))),this}draw(){return e(this,void 0,void 0,(function*(){i(this.imageQueue)||(yield this.preloadImage()),this.render()}))}downloadImage(t){return new Promise(((e,a)=>{s({src:t.url,success:t=>{e()},fail:t=>{console.error(t),a(t)}})}))}preloadImage(){return e(this,void 0,void 0,(function*(){yield Promise.all(this.imageQueue.map((t=>this.downloadImage(t))))}))}setBackground(t){this.ctx.fillStyle=t}setBorder(t){const e=t.x,a=t.y,i=t.width,s=null==i?0:i,n=t.height,l=null==n?0:n,h=t.borderWidth,c=t.borderColor,r=t.radius;if(null==h||null==c)return;this.ctx.lineWidth=h,this.ctx.strokeStyle=c;let o=h/2;null!=r?(this.drawRadius(e-o,a-o,s+2*o,l+2*o,r+o),this.ctx.stroke()):this.ctx.strokeRect(e-o,a-o,s+2*o,l+2*o)}setTransform(t){var e,a,i,s;const n=this.ctx;null==t.translateX&&null==t.translateY||n.translate(null!==(e=t.translateX)&&void 0!==e?e:0,null!==(a=t.translateY)&&void 0!==a?a:0),null!=t.rotate&&n.rotate(t.rotate*Math.PI/180),null!=t.scale?n.scale(t.scale,t.scale):null==t.scaleX&&null==t.scaleY||n.scale(null!==(i=t.scaleX)&&void 0!==i?i:1,null!==(s=t.scaleY)&&void 0!==s?s:1)}drawRadius(t,e,a,i,s){const n=Math.min(a/2,i/2),l=Math.min(s,n);this.ctx.beginPath(),this.ctx.moveTo(t+l,e),this.ctx.lineTo(t+a-l,e),this.ctx.arc(t+a-l,e+l,l,-Math.PI/2,0),this.ctx.lineTo(t+a,e+i-l),this.ctx.arc(t+a-l,e+i-l,l,0,Math.PI/2),this.ctx.lineTo(t+l,e+i),this.ctx.arc(t+l,e+i-l,l,Math.PI/2,Math.PI),this.ctx.lineTo(t,e+l),this.ctx.arc(t+l,e+l,l,Math.PI,-Math.PI/2),this.ctx.closePath()}cropImage(t,e,a,i,s,n,l){let h=0,c=0,r=i,o=s,u=n,d=l,x=e,m=a;const g=i/s,v=e/a;switch(t){case"scaleToFill":break;case"aspectFit":g>v?(x=e,m=e/g,u=n,d=l+(a-m)/2):(x=a*g,m=a,u=n+(e-x)/2,d=l);break;case"aspectFill":if(g>v){const t=s*v;h=(i-t)/2,r=t}else{const t=i/v;c=(s-t)/2,o=t}break;case"center":h=Math.max(0,(i-e)/2),c=Math.max(0,(s-a)/2),r=Math.min(i,e),o=Math.min(s,a),u=n+Math.max(0,(e-i)/2),d=l+Math.max(0,(a-s)/2),x=r,m=o;break;case"top":h=Math.max(0,(i-e)/2),c=0,r=Math.min(i,e),o=Math.min(s,a),u=n+Math.max(0,(e-i)/2),d=l,x=r,m=o;break;case"bottom":h=Math.max(0,(i-e)/2),c=Math.max(0,s-a),r=Math.min(i,e),o=Math.min(s,a),u=n+Math.max(0,(e-i)/2),d=l+Math.max(0,a-s),x=r,m=o;break;case"left":h=0,c=Math.max(0,(s-a)/2),r=Math.min(i,e),o=Math.min(s,a),u=n,d=l+Math.max(0,(a-s)/2),x=r,m=o;break;case"right":h=Math.max(0,i-e),c=Math.max(0,(s-a)/2),r=Math.min(i,e),o=Math.min(s,a),u=n+Math.max(0,e-i),d=l+Math.max(0,(a-s)/2),x=r,m=o;break;case"topLeft":h=0,c=0,r=Math.min(i,e),o=Math.min(s,a),u=n,d=l,x=r,m=o;break;case"topRight":h=Math.max(0,i-e),c=0,r=Math.min(i,e),o=Math.min(s,a),u=n+Math.max(0,e-i),d=l,x=r,m=o;break;case"bottomLeft":h=0,c=Math.max(0,s-a),r=Math.min(i,e),o=Math.min(s,a),u=n,d=l+Math.max(0,a-s),x=r,m=o;break;case"bottomRight":h=Math.max(0,i-e),c=Math.max(0,s-a),r=Math.min(i,e),o=Math.min(s,a),u=n+Math.max(0,e-i),d=l+Math.max(0,a-s),x=r,m=o}return{sx:h,sy:c,sw:r,sh:o,dx:u,dy:d,dw:x,dh:m}}getTextRows(t){var e=t.content,a=t.fontSize,i=null==a?14:a,s=t.width,n=null==s?100:s,l=t.lineClamp,h=null==l?1:l,c=t.overflow,r=t.letterSpace,o=null==r?0:r,u=t.fontFamily,d=null==u?"sans-serif":u,x=t.fontWeight,m=null==x?"normal":x;this.ctx.save(),this.ctx.font="".concat(m," ").concat(i,"px ").concat(d);let g=[""],v=0;for(let f=0;f<e.length;f++){const t=e.charAt(f),a=this.ctx.measureText(t).width,i=g[g.length-1].length>0&&o>0,s=a+(i?o:0);if(v+s>n)v=a,g.push(t);else{if("ellipsis"==c&&g.length==h){if(v+s+(i?o:0)+this.ctx.measureText("...").width>n){g[g.length-1]+="...";break}}v+=s,g[g.length-1]+=t}}return this.ctx.restore(),g}divRender(t){const e=t.x,a=t.y,i=t.width,s=null==i?0:i,n=t.height,l=null==n?0:n,h=t.radius,c=t.backgroundColor,r=null==c?"#fff":c,o=t.opacity,u=null==o?1:o,d=t.scale,x=t.scaleX,m=t.scaleY,g=t.rotate,v=t.translateX,f=t.translateY;this.ctx.save(),this.ctx.globalAlpha=u,this.setBackground(r),this.setBorder(t),this.setTransform({scale:d,scaleX:x,scaleY:m,rotate:g,translateX:v,translateY:f}),null!=h?(this.drawRadius(e,a,s,l,h),this.ctx.fill()):this.ctx.fillRect(e,a,s,l),this.ctx.restore()}textRender(t){let e=t.fontSize,a=null==e?14:e,i=t.textAlign,s=t.width,n=t.color,l=null==n?"#000000":n,h=t.x,c=t.y,r=t.letterSpace,o=t.lineHeight,u=t.fontFamily,d=null==u?"sans-serif":u,x=t.fontWeight,m=null==x?"normal":x,g=t.opacity,v=null==g?1:g,f=t.scale,w=t.scaleX,p=t.scaleY,y=t.rotate,M=t.translateX,b=t.translateY;null==o&&(o=1.4*a),this.ctx.save(),this.setTransform({scale:f,scaleX:w,scaleY:p,rotate:y,translateX:M,translateY:b}),this.ctx.font="".concat(m," ").concat(a,"px ").concat(d),this.ctx.globalAlpha=v,this.ctx.fillStyle=l;const S=this.getTextRows(t);let k=0;if(null!=i&&null!=s&&(null==r||r<=0))switch(this.ctx.textAlign=i,i){case"left":break;case"center":k=s/2;break;case"right":k=s}else this.ctx.textAlign="left";const I=o-a;for(let T=0;T<S.length;T++){const t=S[T],e=(T+1)*a+c+I*T;if(null!=r&&r>0){let a=0;for(let e=0;e<t.length;e++)a+=this.ctx.measureText(t.charAt(e)).width,e<t.length-1&&(a+=r);let n=h;"center"==i&&null!=s?n=h+(s-a)/2:"right"==i&&null!=s&&(n=h+s-a);let l=n;for(let i=0;i<t.length;i++){const a=t.charAt(i);this.ctx.fillText(a,l,e),l+=this.ctx.measureText(a).width,i<t.length-1&&(l+=r)}}else this.ctx.fillText(t,h+k,e)}this.ctx.restore()}imageRender(t){return e(this,void 0,void 0,(function*(){return new Promise((e=>{var a;this.ctx.save(),this.ctx.globalAlpha=null!==(a=t.opacity)&&void 0!==a?a:1,this.setTransform({scale:t.scale,scaleX:t.scaleX,scaleY:t.scaleY,rotate:t.rotate,translateX:t.translateX,translateY:t.translateY}),null!=t.radius&&(this.drawRadius(t.x,t.y,t.width,t.height,t.radius),this.ctx.clip());const i=this.imageQueue[0];let s;s=new Image,s.src=i.url,s.onload=()=>{if(null!=t.mode){let e,a;e=s.height,a=s.width;const n=this.cropImage(t.mode,i.width,i.height,a,e,i.x,i.y),l=n.sx,h=n.sy,c=n.sw,r=n.sh,o=n.dx,u=n.dy,d=n.dw,x=n.dh;this.ctx.drawImage(s,l,h,c,r,o,u,d,x)}else this.ctx.drawImage(s,i.x,i.y,i.width,i.height);this.ctx.restore(),this.imageQueue.shift(),e()}}))}))}render(){return e(this,void 0,void 0,(function*(){for(let t=0;t<this.renderQuene.length;t++){const e=this.renderQuene[t];yield e()}}))}}const O=n({__name:"cl-canvas",props:{canvasId:{type:String,default:""},height:{type:Number,default:300},width:{type:Number,default:300}},emits:["load"],setup(t,a){var i=a.expose,s=a.emit;const n=t,w=s,p=T(),y=(M=n.canvasId,new P(M));var M;const b=l(null);function S(){return e(this,void 0,void 0,(function*(){return I(b.value)}))}return h((()=>{y.create().then((()=>{y.height(n.height),y.width(n.width),w("load",y)}))})),i(new UTSJSONObject({createImage:S,saveImage:function(){return e(this,void 0,void 0,(function*(){const t=yield S();d({filePath:t,success:()=>{p.showToast({message:x("保存图片成功"),type:"success"})},fail:t=>{console.error("[cl-canvas]",t),p.showToast({message:x("保存图片失败"),type:"error"})}})}))},previewImage:function(){return e(this,void 0,void 0,(function*(){const t=yield S();u({urls:[t]})}))}})),(e=null,a=null)=>{const i=f,s=m;return c(),r(s,new UTSJSONObject({class:"cl-canvas"}),new UTSJSONObject({default:o((()=>[g(i,new UTSJSONObject({ref_key:"canvasRef",ref:b,id:t.canvasId,style:v({width:t.width+"px",height:t.height+"px"})}),null,8,["id","style"])])),_:1}))}}}),Q=n({__name:"canvas",setup(t){const e=T(),a=l(null),i=l(0),s=l(0);function n(t){t.image({x:0,y:0,width:s.value,height:i.value,url:"/static/demo/canvas/bg.png"}).image({x:0,y:0,width:s.value,height:i.value,url:"/static/demo/canvas/light.png"}).image({x:(s.value-226)/2,y:60,width:226,height:77,url:"/static/demo/canvas/text-yqhy.png"}).image({x:(s.value-325)/2,y:125,width:325,height:77,url:"/static/demo/canvas/text-dezk.png"}).image({x:(s.value-196)/2,y:190,width:196,height:62,url:"/static/demo/canvas/text-xrfl.png"}).image({x:(s.value-374)/2-1,y:500,width:374,height:220,url:"/static/demo/canvas/rp-t.png"}).image({x:(s.value-327)/2,y:280,width:327,height:430,url:"/static/demo/canvas/bg-content.png"}).image({x:30,y:240,width:114,height:120,url:"/static/demo/canvas/gold-l.png"}).image({x:s.value-106-50,y:240,width:106,height:107,url:"/static/demo/canvas/gold-r.png"}).image({x:(s.value-350)/2,y:595,width:350,height:122,url:"/static/demo/canvas/rp-b.png"}).image({x:(s.value-208)/2,y:631,width:208,height:89,url:"/static/demo/canvas/invite-btn.png"}).div({x:(s.value-276)/2,y:335,width:276,height:210,backgroundColor:"#fff",radius:10}).text({x:0,y:350,width:s.value,content:"新人专享",color:"#F73035",textAlign:"center",fontSize:28,fontWeight:"bold"}).text({x:0,y:390,width:s.value,content:"限时领券30元",color:"#F73035",textAlign:"center",fontSize:16}).image({x:(s.value-246)/2,y:432,width:246,height:98,url:"/static/demo/canvas/coupon.png"}).text({x:(s.value-246)/2,y:435,content:"领券",width:34,color:"#fff",fontSize:11,textAlign:"center"}).text({x:(s.value-246)/2,y:454,width:86,content:"80",color:"#604E44",fontSize:46,textAlign:"center",fontWeight:"bold"}).text({x:(s.value-246)/2+86,y:459,width:160,content:"新人专享优惠券",color:"#604E44",fontSize:18,textAlign:"center"}).text({x:(s.value-246)/2+86,y:489,width:160,content:"2021.04.30-2021.06.30",color:"#604E44",fontSize:12,textAlign:"center"}).text({x:0,y:560,width:s.value,content:"邀请好友，双方均可获得20元优惠券",color:"#756056",fontSize:15,textAlign:"center"}).text({x:0,y:300,width:s.value,content:"～ 专属新人福利 ～",color:"#956056",textAlign:"center",opacity:.7}).draw()}function h(){a.value.previewImage()}return R((()=>{i.value=w().windowHeight,s.value=w().windowWidth,e.showConfirm({title:x("提示"),message:x("本页面内容由 canvas 渲染生成，是否立即预览图片效果？"),confirmText:x("预览"),callback(t){"confirm"==t&&a.value.previewImage()}})})),(t=null,e=null)=>{const l=_(p("cl-canvas"),O),u=_(p("cl-button"),A),d=_(p("cl-footer"),Y),m=_(p("cl-page"),X);return c(),r(m,null,new UTSJSONObject({default:o((()=>[s.value>0?(c(),r(l,new UTSJSONObject({key:0,ref_key:"canvasRef",ref:a,"canvas-id":"test",height:i.value,width:s.value,onLoad:n}),null,8,["height","width"])):y("",!0),g(d,null,{default:o((()=>[g(u,new UTSJSONObject({type:"primary",onClick:h}),{default:o((()=>[M(b(S(x)("预览图片")),1)])),_:1})])),_:1})])),_:1}))}}});export{Q as default};
